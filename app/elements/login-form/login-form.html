<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/firebase-element/firebase-element.html">
<link rel="import" href="../../bower_components/firebase-element/firebase-login.html">

<polymer-element name="login-form" attributes="">
    <template>        
        <link rel="stylesheet" href="login-form.css">
         
        <firebase-login id="baseLogin" user="{{user}}" statusKnown="{{statusKnown}}" location="https://comicsense.firebaseio.com/" provider="{{provider}}" on-login="{{onLogin}}" on-error="{{onLoginError}}" on-user-created="{{userCreated}}"></firebase-login>
       
   
        <firebase-element id="userBase" location="https://comicsense.firebaseio.com/usersonline"></firebase-element>
        
        <pvc-globals values="{{globals}}"></pvc-globals>
        
        <div id="loginFormWrapper" hidden?="{{!statusKnown || user}}">
            <div id="errorContainer"></div>
            
            <form id="loginForm" layout horizontal center>
                <label for="s_loginInput">E-mail</label>
                <input type="text" id="s_loginInput" value="{{email}}" placeholder="E-mail address" />

                <label for="s_passwordInput">Password</label>
                <input type="password" id="s_passwordInput" value="{{password}}" placeholder="Password" />

                <input type="button" value="Sign in" on-click="{{signinAction}}" />
                <input type="button" value="Registration" on-click="{{switchViewAction}}"  />
            </form>

            <form id="registerForm" layout horizontal center>
                <label for="loginInput">Email</label>
                <input type="text" id="r_loginInput" value="{{rEmail}}" placeholder="E-mail address" />

                <label for="passwordInput">Password</label>
                <input type="password" id="r_passwordInput" value="{{rPassword}}" placeholder="Password" />

                <input type="button" value="Register" on-click="{{registerAction}}" />
                <input type="button" value="Sign in" on-click="{{switchViewAction}}" />
            </form>
            
            <ul>
                <li><input type="button" value="Login with Facebook" on-click="{{signinFacebook}}" /></li>
                <li><input type="button" value="Login with Google" on-click="{{signinGoogle}}" /></li>
                <li><input type="button" value="Login with Twitter" on-click="{{signinTwitter}}" /></li>
                <li><input type="button" value="Login with Github" on-click="{{signinGithub}}" /></li>
            </ul>
        </div>
    </template>
    <script>
    (function () {

      Polymer({  
        provider : {},
        onlineUserAdded : false,
          
        domReady : function () {        
        },
        signinAction : function () {        
            this.provider = "password";         
            this.$.baseLogin.login({'email':this.email, 'password':this.password}, {'username' : this.email.split('@')[0]});     
            return false;
        },
        registerAction : function () { 
            this.provider = "password";            
            this.$.baseLogin.createUser(this.rEmail,this.rPassword);
            console.log('register log');
        },          
        switchViewAction : function () {         
            $(this.$.loginFormWrapper).toggleClass('register-state');
        },
          
        // sign in by Social hub  
        signinFacebook : function () { 
            this.provider = "facebook";
            this.$.baseLogin.login(); 
        },
        signinGoogle : function () {  
            this.provider = "google";  
            this.$.baseLogin.login();            
        },
        signinGithub : function () {  
            this.provider = "github";        
            this.$.baseLogin.login();
        },
        signinTwitter : function () { 
            this.provider = "twitter"; 
            this.$.baseLogin.login();
        },
          
        onLogin : function() {
            this.globals.currentUser = this.user; 
            this.saveUserNickname();
            this.newOnlineUser();
            //document.querySelector('app-router').go('/scene');
        },
        onLoginError : function (err) {
            console.log("An error occured.", err);
            this.statusKnown = true;
            this.$.errorContainer.innerHTML = err.detail; 
        },
        userCreated : function () {
            this.$.baseLogin.login({'email':this.rEmail, 'password':this.rPassword});   
            console.log("userCreated"); 
        },  
          
        saveUserNickname : function () {
            switch(this.user.provider) {
                case 'password':
                    this.globals.currentUser.nickname = this.user.password.email.split("@")[0];
                break;
        
                case 'google':
                    this.globals.currentUser.nickname = this.user.google.cachedUserProfile.given_name;
                break;
        
                case 'github':
                    this.globals.currentUser.nickname = this.user.github.username;
                break;
        
                case 'facebook':
                    this.globals.currentUser.nickname = this.user.facebook.cachedUserProfile.first_name;
                break;
        
                case 'twitter':
                    this.globals.currentUser.nickname = this.user.twitter.username;
                break;
        
            }
        },
          
        newOnlineUser : function () { 
            if(!this.onlineUserAdded) {
              this.$.userBase.push({username : this.globals.currentUser.nickname, uid : this.globals.currentUser.auth.uid});
              this.onlineUserAdded = true;
            }
        }
      });

    })();
    </script>
</polymer-element>