<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/firebase-element/firebase-element.html">

<polymer-element name="scene-editor" attributes="sceneNr activate">
  <template>
    <style>
    :host {
      display: block;
      position: relative;
      background-color: white;
      width: 100%;
      font-size: 1.2rem;
      font-weight: 300;
    }
    .holder {
      text-align: center;
    }
    .holder canvas {
      margin: 0 auto;
      bordeR: solid 1px #888;
    }
    .buttons {
      clear: both;
      margin-top: 3em;
    }
    input[type="image"] {
      width: 100px;
      height: 100px;
    }
    </style>
    <section id="sceneEditor" hidden?={{!activate}}>
      <div class="holder" id="dragArea" >
        <canvas id="c1" width="{{cwidth}}" height="{{cheight}}"  ></canvas>
      </div>

      <div id="btns" class="buttons">
        <!-- TO BE DONE - widget for asseiejts -->
      <input type="image" class="asset" src="/assets/as1.png" alt="hopek" dragabble="true" />
      <input type="image" class="asset" src="/assets/as2.png" dragabble="true" />
      <input type="image" class="asset" src="/assets/as3.png" alt="gwiazdka" dragabble="true" />
      <input type="image" class="bg" src="/assets/b1.png" dragabble="true" />
      <input type="image" class="bg" src="/assets/b2.jpg" dragabble="true" />
      <input type="image" class="cloud" src="/assets/c1.jpeg" dragabble="true" />
      <input type="image" class="cloud" src="/assets/cloud2.svg" dragabble="true" />

      <button type="reset" id="reset" >Clear</button>
      <button type="submit" id="save" >Save</button>
      </div>
    </section>
    <pvc-globals values="{{globals}}"></pvc-globals>
    <firebase-element id="fbase" location="https://comicsense.firebaseio.com/currentComics" data="{{data}}" keys="{{keys}}" log="true" ></firebase-element>
   
  </template>
  <script>
  Polymer({
    canvas: null,
    cwidth: 800,
    cheight: 450,
    _self: null,
    data: null,

    allowDropAction: function(ev) {
      ev.originalEvent.preventDefault();
    },
      
    observe : {
        'activate' : 'ready'
    },

    dragAction: function(ev) {
        //console.log(ev);
        var type = "asset";
        if($(ev.originalEvent.target).hasClass("bg")) {
            type = "bg";
        } if($(ev.originalEvent.target).hasClass("cloud")) { 
            type = "cloud";
        }
        ev.originalEvent.dataTransfer.setData("text", '{"src": "'+ev.originalEvent.target.src+'","type":"'+type+'"}');
        console.log("drag");
    },
      
    autoSaveSceneAction: function() {
        var date = new Date();
        var id = _self.globals.currentUser.auth.uid;
        var item =
            {  
                image: this.canvas.toSVG(),
                author_id: id,
                author: "kaka",
                f_inprogress: true,
                f_done: false,
                data: date.toDateString() 
            }
      //get global current id ?
        _self.data.scenes[_self.globals.sceneEditorNumber] = item; 
        _self.$.fbase.commit();
    },
    setTextPosition: function(id) {
      text = _self.$.c1.clouds[id]['text'];
      img = _self.$.c1.clouds[id]['img']
      text.setAngle(img.getAngle());
      text.setLeft(img.getLeft() + (img.getWidth() - text.getWidth())/2);
      text.setTop(img.getTop() + 30);
    },

    dropAction: function(ev) {
        ev.originalEvent.preventDefault();
        var data = ev.originalEvent.dataTransfer.getData("text");
        data = JSON.parse(data);
        console.log("Ofsety X: "+ev.originalEvent.offsetX+" Y: "+ev.originalEvent.offsetY);
        if(data.type == "bg") {
          _self.insertBackgroundAction(data.src);
        } else if(data.type == "cloud") {
          _self.insertCloudAction(data.src);
        } else {
          _self.insertItemAction(data.src, ev.originalEvent.offsetX,ev.originalEvent.offsetY );
        }        
    },
    insertBackgroundAction: function(url) {
        fabric.Image.fromURL(url, function(oImg) {
          console.log(" jestem tu");
          oImg.set({width: _self.$.c1.width, height: _self.$.c1.height, top: 0, left: 0});
          _self.$.c1.fabric.setBackgroundColor(
              {
                source: url,
                repeat: 'no-repeat'
              },
              _self.$.c1.fabric.renderAll.bind(_self.$.c1.fabric)
            );
          //or add item in bg replacing existing so you can fit it in.
          /*_self.$.c1.fabric.add(oImg)
          _self.$.c1.fabric.sendToBack(oImg);*/
          _self.autoSaveSceneAction();
        });
    },
    insertItemAction: function(url, x, y) {
        fabric.Image.fromURL(url, function(oImg) {
          oImg.set({width: 50, height: 50, top: x, left: y});
          _self.$.c1.fabric.add(oImg)
        });
        _self.autoSaveSceneAction();
    },
    insertCloudAction: function(url) {
      fabric.Image.fromURL(url, function(img) {
        var id = _self.$.c1.clouds.length;
        img.scale(1.0);
      
        img.on({
          'selected' : function(){
            if ( !(id in _self.$.c1.clouds) ){
              var text = new fabric.IText("Write your text", {
                  fontFamily: 'Comic Sans',
                  fontSize: 20
              });
              _self.$.c1.clouds[id] = {};
              _self.$.c1.clouds[id]['text'] = text 
              _self.$.c1.clouds[id]['img'] = img
              _self.$.c1.clouds[id]['clicked'] = 1
              _self.setTextPosition(id);  
                      
                      text.setWidth(10);
              _self.$.c1.fabric.add(text);  
            }
             _self.$.c1.clouds[id]['clicked'] += 1
            if (_self.$.c1.clouds[id]['clicked'] > 1){
              var text =  _self.$.c1.clouds[id]['text']
                  _self.$.c1.fabric.setActiveObject(text);
                  text.selectAll();
                  text.enterEditing();  
            }
          },
          'modified' : function(){
            _self.setTextPosition(id);
            _self.$.c1.fabric.renderAll();
             _self.$.c1.clouds[id]['clicked'] = 0;
            _self.$.c1.fabric.setActiveObject(text);
            _self.$.c1.fabric.setActiveObject(img);
          }
        })
        _self.$.c1.fabric.add(img);
        });      
        _self.autoSaveSceneAction();
    },


    prepareBoardAction: function() {
      this.canvas.selectionColor = 'rgba(0,255,0,0.3)';
      this.canvas.selectionBorderColor = 'red';
      this.canvas.selectionLineWidth = 5;
      this.canvas.renderAll();
    },

    clearBoardAction: function(ev) {
        _self.$.c1.fabric.clear();
        _self.prepareBoardAction();
    },
    saveAction: function(ev) {
        var date = new Date();
        var item = {
              author: "anonymous guest",
              f_done: true,
              f_inprogress: false,
              date: date.toDateString(),
              image: _self.$.c1.fabric.toSVG()
            }
        _self.data.scenes[_self.globals.sceneEditorNumber] = item;
        _self.$.fbase.commit();     
        
        _self.globals.sceneEditorActivate = false;

    },


    ready: function() {
      if(this.activate) {
          this.canvas = new fabric.Canvas(this.$.c1, { backgroundColor: "#9ff" });
          //to have a more głobał accesss
          this.$.c1.fabric = this.canvas;
          this.$.c1.fabric.clear();
          this.$.c1.clouds = {};
           
          //this.canvas.add(new fabric.Circle({ radius: 30, fill: '#ff5', top: 100, left: 100 }));
          this.prepareBoardAction();

          $(this.$.dragArea).on("drop", this.dropAction);
          $(this.$.dragArea).on("dragover", this.allowDropAction);
          $(this.$.btns).find("input").on("dragstart", this.dragAction);
          $(this.$.btns).find("button#reset").click(this.clearBoardAction);
          $(this.$.btns).find("button#save").click(this.saveAction);
          _self = this;
      }
    }

  });

  </script>
</polymer-element>