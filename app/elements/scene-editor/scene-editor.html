<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/firebase-element/firebase-element.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/core-icons/core-icons.html">

<polymer-element name="scene-editor" attributes="sceneNr activate">
  <template>
    <style>
    :host {
      display: block;
      position: relative;
      background-color: white;
      width: 100%;
      font-size: 1.2rem;
      font-weight: 300;
    }
    .holder {
      text-align: center;
      float: left; 
      margin: 20px;
    }
    .holder canvas {
      margin: 0 auto;
      border: solid 3px #666;
      border-radius: 5px;
    }
    .holder:hover canvas { 
        border-color: #000;
    }
    .assets div {
      border-bottom: solid 1px #eee;
      padding: 5px 0;
    }
    .buttons {
      
      margin-top: 3em;
    }
    input[type="image"] {
      width: 100px;
      height: 100px;
    }
    </style>
    <firebase-element id="fbase" data="{{data}}" location="https://comicsense.firebaseio.com/currentComics"></firebase-element>
    <section id="sceneEditor">
      <h1>Edit scene {{scenaNr}}</h1>
      <counter-view starttimer="true"></counter-view>
      <div class="holder" id="dragArea" >
        <canvas id="c1" width="{{cwidth}}" height="{{cheight}}"  ></canvas>
      </div>
      <div id="assety" class="assets">
        <!-- TO BE DONE - widget for asseiejts -->
        <div>
          <input type="image" class="asset" src="/assets/items/pan01.svg" alt="pan01" dragabble="true" />
          <input type="image" class="asset" src="/assets/items/pan02.svg" alt="pan02" dragabble="true" />
          <input type="image" class="asset" src="/assets/items/pan03.png" alt="pan03" dragabble="true" />        
          <input type="image" class="asset" src="/assets/items/as1.png" alt="hopek" dragabble="true" />
          <input type="image" class="asset" src="/assets/items/as2.png" dragabble="true" />
          <input type="image" class="asset" src="/assets/items/as3.png" alt="gwiazdka" dragabble="true" />
        </div><div>
          <input type="image" class="bg" src="/assets/bgs/b1.png" dragabble="true" />
          <input type="image" class="bg" src="/assets/bgs/b2.jpg" dragabble="true" />
          </div><div>
          <input type="image" class="cloud" src="/assets/clouds/c1.jpeg" dragabble="true" />
          <input type="image" class="cloud" src="/assets/clouds/cloud2.svg" dragabble="true" />
        </div>
      </div>      
      <div id="actions" class="buttons">
        <paper-button on-click="{{cutAsset}}" raised ><core-icon icon="content-cut" role="img"></core-icon>&nbsp;&nbsp;Cut</paper-button>
        <paper-button on-click="{{clearBoardAction}}" raised ><core-icon icon="delete" role="img"></core-icon>&nbsp;&nbsp;Clear</paper-button>
        <paper-button on-click="{{saveAction}}" raised ><core-icon icon="save" role="img"></core-icon>&nbsp;&nbsp;Save</paper-button>
      </div>

    </section>
    <pvc-globals values="{{globals}}"></pvc-globals>

   
  </template>
  <script>
  Polymer({
    canvas: null,
    cwidth: 390,
    cx: 0,
    cy: 0,
    cheight: 500,
    _self: null,
    data: null,
    start: null,

    allowDropAction: function(ev) {
      ev.originalEvent.preventDefault();
    },
       
    domReady : function() {
        this.start = true;
    },

    dragAction: function(ev) {
        //console.log(ev);
        var type = "asset";
        if($(ev.originalEvent.target).hasClass("bg")) {
            type = "bg";
        } if($(ev.originalEvent.target).hasClass("cloud")) { 
            type = "cloud";
        }
        ev.originalEvent.dataTransfer.setData("text", '{"src": "'+ev.originalEvent.target.src+'","type":"'+type+'"}');
        console.log("drag");
    },
    cutAsset: function() {
      this.canvas.fxRemove(this.canvas.getActiveObject());
      this.autoSaveSceneAction();
    },
      
    autoSaveSceneAction: function() {
        _self = this;
        var date = new Date();
        //console.log(_self.currentUser);
        var item =
            {  
                image: _self.canvas.toSVG(),
                author_id: _self.globals.currentUser.auth.uid,
                author: _self.globals.currentUser.nickname,
                f_inprogress: true,
                f_done: false,
                data: date.toDateString() 
            }
      //get global current id ?
        _self.data.scenes[_self.globals.sceneEditorNumber] = item; 
        _self.$.fbase.commit();
    },
    setTextPosition: function(id) {
      text = _self.$.c1.clouds[id]['text'];
      img = _self.$.c1.clouds[id]['img']
      text.setAngle(img.getAngle());
      text.setLeft(img.getLeft() + (img.getWidth() - text.getWidth())/2);
      text.setTop(img.getTop() + 30);
    },

    dropAction: function(ev) {
        ev.originalEvent.preventDefault();
        var data = ev.originalEvent.dataTransfer.getData("text");
        data = JSON.parse(data);
        console.log("Ofsety X: "+ev.originalEvent.offsetX+" Y: "+ev.originalEvent.offsetY);
        if(data.type == "bg") {
          _self.insertBackgroundAction(data.src);
        } else if(data.type == "cloud") {
          _self.insertCloudAction(data.src);
        } else {
          _self.insertItemAction(data.src, ev.originalEvent.offsetX,ev.originalEvent.offsetY );
        }        
    },

    insertBackgroundAction: function(url) {
        fabric.Image.fromURL(url, function(oImg) {
          console.log(" jestem tu");
          oImg.set({width: _self.$.c1.width, height: _self.$.c1.height, top: 0, left: 0});
          _self.$.c1.fabric.setBackgroundColor(
              {
                source: url,
                repeat: 'no-repeat'
              },
              _self.$.c1.fabric.renderAll.bind(_self.$.c1.fabric)
            );
          //or add item in bg replacing existing so you can fit it in.
          /*_self.$.c1.fabric.add(oImg)
          _self.$.c1.fabric.sendToBack(oImg);*/
          _self.autoSaveSceneAction();
        });
    },
    insertItemAction: function(url, x, y) {
        fabric.Image.fromURL(url, function(oImg) {
          oImg.set();
          _self.$.c1.fabric.add(oImg)
        });
        _self.autoSaveSceneAction();
    },
    insertCloudAction: function(url) {
      fabric.Image.fromURL(url, function(img) {
        var id = _self.$.c1.clouds.length;
        img.scale(1.0);
      
        img.on({
          'selected' : function(){
            if ( !(id in _self.$.c1.clouds) ){
              var text = new fabric.IText("Write your text", {
                  fontFamily: 'Pintass',
                fontSize: 20
              });
              _self.$.c1.clouds[id] = {};
              _self.$.c1.clouds[id]['text'] = text 
              _self.$.c1.clouds[id]['img'] = img
              _self.$.c1.clouds[id]['clicked'] = 1
              _self.setTextPosition(id);  
                      
                      text.setWidth(10);
              _self.$.c1.fabric.add(text);  
            }
             _self.$.c1.clouds[id]['clicked'] += 1
            if (_self.$.c1.clouds[id]['clicked'] > 1){
              var text =  _self.$.c1.clouds[id]['text']
                  _self.$.c1.fabric.setActiveObject(text);
                  text.selectAll();
                  text.enterEditing();  
            }
          },
          'modified' : function(){
            _self.setTextPosition(id);
            _self.$.c1.fabric.renderAll();
             _self.$.c1.clouds[id]['clicked'] = 0;
            _self.$.c1.fabric.setActiveObject(text);
            _self.$.c1.fabric.setActiveObject(img);
          }
        })
        _self.$.c1.fabric.add(img);
        });      
        _self.autoSaveSceneAction();
    },


    prepareBoardAction: function() {
      this.canvas.selectionColor = 'rgba(0,255,0,0.3)';
      this.canvas.selectionBorderColor = 'red';
      this.canvas.selectionLineWidth = 5;
      this.canvas.renderAll();
    },

    clearBoardAction: function(ev) {
        _self.$.c1.fabric.clear();
        _self.$.c1.fabric.deactivateAllWithDispatch()
        this.$.c1.clouds = {};
        _self.$.c1.fabric.setBackgroundColor("#9FF");
        _self.prepareBoardAction();
    },
    saveAction: function(ev) {
        var date = new Date();
        var item = {
              author: "anonymous guest",
              f_done: true,
              f_inprogress: false,
              date: date.toDateString(),
              image: _self.$.c1.fabric.toSVG()
            }
        _self.data.scenes[_self.globals.sceneEditorNumber] = item;
        _self.$.fbase.commit();     
        _self.globals.sceneEditorActivate = false;
        document.querySelector('app-router').go('/scene');

    },
    initialize: function () {
      if( this.$.c1.fabric != null) {
        this.$.c1.clouds = {};
        this.clearBoardAction();
      
      } else {
          this.canvas = new fabric.Canvas(this.$.c1, { backgroundColor: "#9ff" });
          this.$.c1.fabric = this.canvas;
          this.canvas.on('mouse:up', function(options){
            console.log(options);
            console.log(options.e.clientX);

          }); 
          this.$.c1.clouds = {}   
          _self = this;     
      }
    },

     
    ready : function() {
      this.initialize();
      _self = this;
      if(this.globals.sceneEditorActivate) { 
          //this.canvas.add(new fabric.Circle({ radius: 30, fill: '#ff5', top: 100, left: 100 }));
          this.prepareBoardAction();
          $(this.$.dragArea).on("drop", this.dropAction);
          $(this.$.dragArea).on("dragover", this.allowDropAction);
          $(this.$.assety).find("input").on("dragstart", this.dragAction);
          this.clearBoardAction();
      }
       
    }

  });

  </script>
</polymer-element>
