<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/firebase-element/firebase-element.html">



<polymer-element name="comics-view">
    <template>         
        <pvc-globals values="{{globals}}"></pvc-globals>
        <style>
        .comicsTemplate {
            margin:0 auto; 
            height:500px; 
        }
        .comicsTemplateItem {
            width:390px;
            height:100%; 
            float:left;
            border:3px solid #ccc; 
            border-radius:6px;
            margin-right:10px;
        }
        .comicsTemplateItem.available {            
            border:3px dashed #3bb4be; 
            cursor:pointer;
        }
        .comicsTemplateItem.available:hover {
            opacity:0.8;    
        }
        .comicsTemplateItem.done {
            background:white;
            border:3px solid black;
        }
        .comicsTemplateItem.progress {
            background:white;
            border:3px dashed red;
        }
        #comicsInProgress {
            display:none;
        }
        .inProgress #comicsInProgress {
            display:block;
        }
        .inProgress #comicsNew {
            display:none;
        }
        </style>
        
        <firebase-element id="base" data="{{data}}" location="https://comicsense.firebaseio.com/currentComics"></firebase-element>
        <firebase-element id="baseComicses" keys={{keys}} data="{{dataComicses}}" location="https://comicsense.firebaseio.com/comicses"></firebase-element>
        
        <section id="comicsView">
            <div id="comicsNew">
                <h1>Create new comics</h1>
                <label for="comicsTitle">Comics Title</label>
                <input id="comicsTitle" type="text" value="{{title}}" />
                <button on-click="{{createNewComicsAction}}">Create new</button>
            </div>


            <div id="comicsInProgress">
                <div>Current comics in progress {{data.title}}</div>

                <div class="comicsTemplate">
                    <div class="comicsTemplateItem {{status[0]}}" on-click="{{editScene}}" data-scenenr="0">
                         <html-echo html="{{data.scenes[0].image}}"></html-echo>
                    </div>            
                    <div class="comicsTemplateItem {{status[1]}}" on-click="{{editScene}}" data-scenenr="1">                
                        <html-echo html="{{data.scenes[1].image}}"></html-echo>
                    </div>            
                    <div class="comicsTemplateItem {{status[2]}}" on-click="{{editScene}}" data-scenenr="2">                
                        <html-echo html="{{data.scenes[2].image}}"></html-echo>
                    </div>
                </div>
            </div>
        </section>
        
        <content></content>
                
        
    </template>
    
    <script>
    (function () {
      Polymer({ 
          status : {},
                     
          oneItemIsAvailable : false,
          oneItemIsInProgress : false,
          comicsMovedtoCollection : false,
          
          
          // lifecycle methods
          domReady : function () { 
            this.loadCurrentComics();  
          },
        
          observe : {
            'data.scenes' : 'dataScenesChanged'  
          },
          
          
          // custom methods
          dataScenesChanged : function () {
            console.log('data changed');
            this.loadCurrentComics();
            if(this.data.scenes[2].f_done) {
                this.moveToDone();
            }
          },
          
                    
          loadCurrentComics : function () {              
              
              this.oneItemIsAvailable = false;
              this.oneItemIsInProgress = false; 
              
              if(this.data && !this.comicsMovedtoCollection) {
                  var _self = this;
                  $(_self.$.comicsView).addClass('inProgress');
                    
                  $(_self.$.comicsInProgress).find('.comicsTemplateItem').each(function(i){ 
                      if (_self.data.scenes[i].f_done) {
                          _self.status[i] = "done";
                      }
                      else if (_self.data.scenes[i].f_inprogress) {
                          _self.status[i] = "progress";
                          _self.oneItemIsInProgress = true;
                          if(_self.data.scenes[i].author_id == _self.globals.currentUser.auth.uid) {
                              _self.globals.sceneEditorActivate = true;
                              _self.globals.sceneEditorNumber = i; 
                          }
                      }
                      else if(!_self.data.scenes[i].f_done && !_self.data.scenes[i].f_inprogress 
                                && !_self.oneItemIsAvailable && !_self.oneItemIsInProgress) {
                           _self.status[i] = 'available';
                          console.log("scene " + i + "is available to edit");
                           _self.oneItemIsAvailable = true;
                      } else {
                          _self.status[i] = '';
                      }
                  });                   
              } else {                  
                  $(this.$.comicsView).removeClass('inProgress');
              }
          },
          
          createNewComicsAction : function () {                
            _self = this;
              
            var newComics = {
                title : _self.title,
                scenes : {
                    '0' : {
                        author_id : '',
                        author : '',
                        date : '',
                        image : '',
                        f_inprogress : false,
                        f_done : false
                    },
                    '1' : {
                        author : '',
                        date : '',
                        image : '',
                        f_inprogress : false,
                        f_done : false
                    },
                    '2' : {
                        author : '',
                        date : '',
                        image : '',
                        f_inprogress : false,
                        f_done : false
                    }
                }
            }
            this.data = newComics; 
          },
          
          editScene : function (e, detail, target) {
            console.log('Edit scene number: ' + target.dataset.scenenr);
              var sceneNr = target.dataset.scenenr;

              //test 
              if($(e.toElement).hasClass('available')) {
                  this.data.scenes[sceneNr].f_inprogress = true;  
                  this.data.scenes[sceneNr].author_id = this.globals.currentUser.auth.uid;
                  this.data.scenes[sceneNr].author = this.globals.currentUser.nickname;
                  this.globals.sceneEditorActivate = true;
                  this.globals.sceneEditorNumber = sceneNr;
                  this.$.base.commit(); 
              }
               document.querySelector('app-router').go('/scene/edit/'+sceneNr);
          },
          
          moveToDone : function () {
            this.$.baseComicses.push({comics : this.data});
            delete this.data; 
            this.comicsMovedtoCollection = true;            
            document.querySelector('app-router').go('/comics/'+this.keys[this.keys.length-1]);
          }
      
      });
    })();
    </script>
</polymer-element>